#!/bin/bash -ex
cd $(cd `dirname "$0"`; cd ..; pwd)

if [ $# != "1" ]; then
  echo "Usage: $0 HOST"
  exit 1
fi

HOST=$1

if [ -z "$HEXAPOD_HOST" ]; then
  echo "Error: HEXAPOD_HOST must be set."
  exit 1
fi

# Set SSH keys
ssh root@$HOST mkdir -p .ssh
rsync -p etc/authorized_keys root@$HOST:.ssh/authorized_keys

# Install Avahi (Zeroconf), set the hostname, and start avahi
ssh root@$HOST dnf install -y -q avahi avahi-tools nss-mdns
ssh root@$HOST hostnamectl set-hostname --static $HEXAPOD_HOST
ssh root@$HOST systemctl start avahi-daemon
